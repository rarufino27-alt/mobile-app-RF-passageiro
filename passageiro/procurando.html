<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>RF ‚Äì Procurando Motorista</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- CORE CORRIGIDO -->
<script src="../core/global.js"></script>

<style>
*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
}

body{
  background:#0f0f0f;
  color:#fff;
  min-height:100vh;
}

/* HEADER PADR√ÉO RF */
.top{
  background:#ffffff;
  padding:25px 20px 55px;
  border-bottom-left-radius:40px;
  border-bottom-right-radius:40px;
}

.logo{
  font-weight:900;
  font-size:1.4rem;
  color:#000;
}

.status{
  margin-top:5px;
  font-weight:700;
  color:#facc15;
}

/* CONTE√öDO */
.content{
  width:90%;
  max-width:420px;
  margin:-40px auto 120px auto;
}

.card{
  background:#1c1c1c;
  border-radius:20px;
  padding:20px;
  box-shadow:0 12px 30px rgba(0,0,0,.5);
}

/* SPINNER */
.spinner{
  width:40px;
  height:40px;
  border:4px solid #333;
  border-top:4px solid #facc15;
  border-radius:50%;
  margin:0 auto 15px;
  animation:spin 1s linear infinite;
}

@keyframes spin{
  to{transform:rotate(360deg);}
}

.linha{
  display:flex;
  justify-content:space-between;
  font-size:.85rem;
  margin-bottom:6px;
}

.linha span:first-child{
  color:#aaa;
}

.total{
  text-align:center;
  font-size:1.4rem;
  font-weight:700;
  color:#facc15;
  margin-top:12px;
}

.timer{
  text-align:center;
  font-size:.75rem;
  color:#888;
  margin-top:8px;
}

.btn-cancel{
  margin-top:15px;
  width:100%;
  padding:14px;
  border:none;
  border-radius:14px;
  background:#111;
  border:1px solid #ef4444;
  color:#ef4444;
  font-weight:600;
  cursor:pointer;
}
</style>
</head>
<body>

<div class="top">
  <div class="logo">PASSAGEIRO RF</div>
  <div class="status" id="statusText">
    Buscando motoristas pr√≥ximos...
  </div>
</div>

<div class="content">
  <div class="card">

    <div class="spinner"></div>

    <div id="detalhamento"></div>

    <div class="total" id="totalFinal"></div>

    <div class="timer" id="timer">
      Tempo de espera: 0s
    </div>

    <button class="btn-cancel" onclick="cancelar()">
      Cancelar corrida
    </button>

  </div>
</div>

<!-- SUPABASE -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="../core/supabase.js"></script>

<script>

// ============================
// DADOS DA CORRIDA
// ============================

const corrida = JSON.parse(localStorage.getItem("rf_corrida_temp")) || {};
const totalFinal = Number(localStorage.getItem("rf_total_final")) || 0;
const categoria = localStorage.getItem("rf_categoria") || "Driver";

const origem = corrida.origem || "-";
const parada = corrida.parada || null;
const destino = corrida.destino || "-";

// ============================
// RENDER DETALHAMENTO
// ============================

let detalhesHTML = `
  <div class="linha">
    <span>Origem</span>
    <span>${origem}</span>
  </div>
`;

if(parada){
  detalhesHTML += `
    <div class="linha">
      <span>Parada</span>
      <span>${parada}</span>
    </div>
  `;
}

detalhesHTML += `
  <div class="linha">
    <span>Destino</span>
    <span>${destino}</span>
  </div>

  <div class="linha">
    <span>Categoria</span>
    <span>${categoria}</span>
  </div>
`;

document.getElementById("detalhamento").innerHTML = detalhesHTML;
document.getElementById("totalFinal").innerText =
  "Total: R$ " + totalFinal.toFixed(2);

// ============================
// TIMER
// ============================

let segundos = 0;

setInterval(()=>{
  segundos++;

  document.getElementById("timer").innerText =
    "Tempo de espera: " + segundos + "s";

  if(segundos === 5){
    document.getElementById("statusText").innerText =
      "Motoristas visualizando sua corrida...";
  }

  if(segundos === 10){
    document.getElementById("statusText").innerText =
      "Conectando com o melhor motorista...";
  }

},1000);

// ============================
// CANCELAR
// ============================

function cancelar(){

  if(confirm("Deseja cancelar a corrida?")){

    localStorage.removeItem("rf_corrida_temp");
    localStorage.removeItem("rf_total_final");
    localStorage.removeItem("rf_categoria");

    App.go("viagem.html");
  }
}

// ============================
// CRIAR CORRIDA
// ============================

async function criarCorrida(){

  if(typeof supabaseClient === "undefined"){
    console.error("‚ùå Supabase n√£o carregado.");
    return;
  }

  console.log("üöÄ Criando corrida...");

  const { data, error } = await supabaseClient
    .from("rides")
    .insert([{
      origem,
      parada,
      destino,
      categoria,
      valor_total: totalFinal,
      status: "procurando"
    }])
    .select()
    .single();

  if(error){
    console.error("‚ùå ERRO SUPABASE:", error);
    alert("Erro ao criar corrida.");
    return;
  }

  console.log("‚úÖ Corrida criada:", data);

  App.set("ride_id", data.id);

  escutarAceite(data.id);
}

// ============================
// ESCUTAR ACEITE
// ============================

function escutarAceite(rideId){

  supabaseClient
    .channel("ride-" + rideId)
    .on(
      "postgres_changes",
      {
        event: "UPDATE",
        schema: "public",
        table: "rides",
        filter: "id=eq." + rideId
      },
      (payload) => {

        console.log("üì° Atualiza√ß√£o recebida:", payload);

        if(payload.new.status === "aceita"){

          document.getElementById("statusText").innerText =
            "Motorista encontrado! üöó";

          setTimeout(()=>{
            window.location.href = "motorista-caminho.html";
          },1200);
        }

      }
    )
    .subscribe((status)=>{
      console.log("Realtime status:", status);
    });
}

criarCorrida();

</script>

</body>
</html>
