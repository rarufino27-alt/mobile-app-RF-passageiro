<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Online - RF Motorista</title>

<link rel="stylesheet" href="../core/ui/layout.css">

<script src="../core/config.js"></script>
<script src="../core/datamanager.js"></script>
<script src="../core/services/soundService.js"></script>
<script src="../core/ui/theme.js" defer></script>
<script src="../core/ui/sidebar.js" defer></script>

<style>
.rf-ride-card{
  margin-top:15px;
  animation:slideUp .4s ease;
}

.ride-header{
  display:flex;
  justify-content:space-between;
  font-weight:600;
  margin-bottom:10px;
}

.ride-timer{
  background:#ef4444;
  color:#fff;
  padding:4px 10px;
  border-radius:20px;
  font-size:14px;
}

.ride-valor{
  text-align:center;
  margin-bottom:15px;
}

.ride-valor h2{
  font-size:30px;
  margin:0;
  color:#22c55e;
}

.ride-negociacao input{
  width:100%;
  padding:10px;
  border-radius:12px;
  border:1px solid #ddd;
  margin-bottom:10px;
}

.ride-actions{
  display:flex;
  gap:6px;
}

.ride-actions button{
  flex:1;
  padding:10px;
  border:none;
  border-radius:20px;
  font-weight:700;
  cursor:pointer;
}

.btn-recusar{ background:#333; color:#fff; }
.btn-enviar{ background:#facc15; color:#000; }
.btn-aceitar{ background:#22c55e; color:#fff; }
</style>

</head>

<body>

<aside id="sidebar" class="sidebar"></aside>
<div id="overlay" class="overlay"></div>

<header class="rf-top">
  <div class="menu-btn" onclick="toggleSidebar()">☰</div>
  <div>RF Motorista</div>
  <div class="credit-box">
    Créditos: <span id="creditosTopo">0.00</span>
  </div>
</header>

<main class="rf-body">

  <div class="rf-card" style="text-align:center;">
    <h3>Ganhos Hoje</h3>
    <h1>R$ <span id="ganhosHoje">0.00</span></h1>
  </div>

  <!-- CARD INDRIVER -->
  <div id="requestCard" class="rf-card rf-ride-card" style="display:none;">

    <div class="ride-header">
      <span>Dinheiro</span>
      <span class="ride-timer" id="contador">15</span>
    </div>

    <div class="ride-valor">
      <h2>R$ <span id="valorSugerido">0.00</span></h2>
      <small>Valor sugerido pelo passageiro</small>
    </div>

    <div>
      <strong>Origem</strong>
      <p id="origem"></p>

      <strong>Destino</strong>
      <p id="destino"></p>
    </div>

    <div class="ride-negociacao">
      <input type="number" id="contraValor" placeholder="Seu valor (opcional)" />
    </div>

    <div class="ride-actions">
      <button class="btn-recusar" onclick="recusarCorrida()">Recusar</button>
      <button class="btn-enviar" onclick="enviarContra()">Enviar</button>
      <button class="btn-aceitar" onclick="aceitarCorrida()">Aceitar</button>
    </div>

  </div>

  <button class="fab fab-offline" onclick="ficarOffline()">
    OFFLINE
  </button>

</main>

<script>

let tempo = 15;
let timerInterval;
let simulacaoTimer = null;

document.addEventListener("DOMContentLoaded", ()=>{

  if(!DataManager.isOnline()){
    window.location.href = "offline.html";
    return;
  }

  atualizarTopo();
  atualizarGanhos();
  iniciarLoopAtualizacao();
  simularCorrida();

});

/* ========================= */
function atualizarTopo(){
  document.getElementById("creditosTopo").innerText =
    DataManager.getCreditos().toFixed(2);
}

function atualizarGanhos(){
  document.getElementById("ganhosHoje").innerText =
    DataManager.getGanhosHoje().toFixed(2);
}

function iniciarLoopAtualizacao(){
  setInterval(()=>{
    atualizarTopo();
    atualizarGanhos();
  },2000);
}

/* ========================= */
function ficarOffline(){
  SoundService.play("OFFLINE");
  DataManager.setOnline(false);
  window.location.href = "offline.html";
}

/* ========================= */
/* SIMULAÇÃO */
function simularCorrida(){

  if(simulacaoTimer) clearTimeout(simulacaoTimer);

  simulacaoTimer = setTimeout(()=>{

    if(!DataManager.isOnline()) return;
    if(DataManager.getCorrida()) return;

    const corrida = DataManager.criarCorridaSimulada();

    mostrarCard(corrida);

  },4000);
}

function mostrarCard(corrida){

  document.getElementById("requestCard").style.display="block";

  document.getElementById("valorSugerido").innerText =
    corrida.valor.toFixed(2);

  document.getElementById("origem").innerText =
    corrida.origem || "Centro";

  document.getElementById("destino").innerText =
    corrida.destino || "Shopping";

  SoundService.play("CHAMADA");

  iniciarContador();
}

function iniciarContador(){

  tempo = 15;

  timerInterval = setInterval(()=>{

    tempo--;
    document.getElementById("contador").innerText = tempo;

    if(tempo <= 0){
      clearInterval(timerInterval);
      recusarCorrida();
    }

  },1000);
}

function aceitarCorrida(){

  clearInterval(timerInterval);

  SoundService.play("ACEITA");

  DataManager.atualizarStatusCorrida("aceita");

  window.location.href="corrida-ativa.html";
}

function recusarCorrida(){

  clearInterval(timerInterval);

  SoundService.play("CANCELADA");

  DataManager.limparCorrida();

  document.getElementById("requestCard").style.display="none";

  simularCorrida();
}

function enviarContra(){

  const valor = parseFloat(document.getElementById("contraValor").value);

  if(!valor || valor <= 0){
    alert("Informe um valor válido.");
    return;
  }

  SoundService.play("MSG_PASSAGEIRO");

  alert("Contra-proposta enviada: R$ " + valor.toFixed(2));
}

</script>

</body>
</html>