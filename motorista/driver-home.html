<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Online - RF Motorista</title>

<link rel="stylesheet" href="../core/ui/layout.css">

<script src="../core/config.js"></script>
<script src="../core/datamanager.js"></script>
<script src="../core/services/soundService.js"></script>
<script src="../core/components/ridecard.js"></script>
<script src="../core/ui/theme.js" defer></script>
<script src="../core/ui/sidebar.js" defer></script>

</head>

<body>

<aside id="sidebar" class="sidebar"></aside>
<div id="overlay" class="overlay"></div>

<header class="rf-top">
  <div class="menu-btn" onclick="toggleSidebar()">☰</div>
  <div>RF Motorista</div>
  <div class="credit-box">
    Créditos: <span id="creditosTopo">0.00</span>
  </div>
</header>

<main class="rf-body">

  <div class="rf-card" style="text-align:center;">
    <h3>Ganhos Hoje</h3>
    <h1>R$ <span id="ganhosHoje">0.00</span></h1>
  </div>

  <button class="fab fab-offline" onclick="ficarOffline()">
    OFFLINE
  </button>

</main>

<script>

let simulacaoTimer = null;

document.addEventListener("DOMContentLoaded", ()=>{

  if(!DataManager.isOnline()){
    window.location.href = "offline.html";
    return;
  }

  atualizarTopo();
  atualizarGanhos();
  iniciarLoopAtualizacao();
  iniciarSimulacao();

});

/* ========================= */
/* ATUALIZAÇÕES VISUAIS */

function atualizarTopo(){
  document.getElementById("creditosTopo").innerText =
    DataManager.getCreditos().toFixed(2);
}

function atualizarGanhos(){
  document.getElementById("ganhosHoje").innerText =
    DataManager.getGanhosHoje().toFixed(2);
}

function iniciarLoopAtualizacao(){
  setInterval(()=>{
    atualizarTopo();
    atualizarGanhos();
  },2000);
}

/* ========================= */
/* OFFLINE */

function ficarOffline(){
  SoundService.play("OFFLINE");
  DataManager.setOnline(false);
  window.location.href = "offline.html";
}

/* ========================= */
/* SIMULAÇÃO */

function iniciarSimulacao(){

  if(simulacaoTimer) clearTimeout(simulacaoTimer);

  simulacaoTimer = setTimeout(()=>{

    if(!DataManager.isOnline()) return;

    const corridaExistente = DataManager.getCorrida();

    // Se existir corrida pendente, apenas mostra o card
    if(corridaExistente && corridaExistente.status === "pendente"){
      RideCard.show(corridaExistente);
      return;
    }

    // Caso contrário cria nova
    const corrida = DataManager.criarCorridaSimulada();

    if(corrida){
      console.log("Corrida simulada:", corrida);
      RideCard.show(corrida);
    }

  },3000);
}

</script>

</body>
</html>