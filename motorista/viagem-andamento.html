<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Viagem em Andamento</title>

<link rel="stylesheet" href="../core/ui/layout.css">

<script src="../core/config.js"></script>
<script src="../core/datamanager.js"></script>
<script src="../core/services/soundService.js"></script>
<script src="../core/ui/theme.js" defer></script>
<script src="../core/ui/sidebar.js" defer></script>
</head>

<body>

<aside id="sidebar" class="sidebar"></aside>
<div id="overlay" class="overlay"></div>

<header class="rf-top">
  <div class="menu-btn" onclick="toggleSidebar()">☰</div>
  <div>Viagem em Andamento</div>
  <div class="credit-box">
    Créditos: <span id="creditosTopo">0.00</span>
  </div>
</header>

<main class="rf-body">

  <div class="rf-card" style="text-align:center;">
    <h2>Viagem em andamento...</h2>
    <p>Siga até o destino</p>
  </div>

  <button class="fab fab-offline" onclick="finalizar()">
    FINALIZAR
  </button>

</main>

<script>

const TAXA_PLATAFORMA = 0.15;

document.addEventListener("DOMContentLoaded", ()=>{

  const corrida = DataManager.getCorrida();

  if(!corrida){
    window.location.href = "driver-home.html";
    return;
  }

  DataManager.atualizarStatusCorrida("andamento");

  document.getElementById("creditosTopo").innerText =
    DataManager.getCreditos().toFixed(2);

});

/* =========================
   FINALIZAR VIAGEM
========================= */

function finalizar(){

  const corrida = DataManager.getCorrida();

  if(!corrida){
    window.location.href = "driver-home.html";
    return;
  }

  const valor = parseFloat(corrida.valor);
  const taxa = valor * TAXA_PLATAFORMA;

  let creditos = DataManager.getCreditos();

  if(creditos < taxa){
    SoundService.play("SEM_CREDITO");
    alert("Créditos insuficientes para pagar a taxa da plataforma.");
    DataManager.setOnline(false);
    window.location.href = "offline.html";
    return;
  }

  /* Desconta taxa */
  DataManager.descontarCreditos(taxa);

  /* Atualiza ganhos do motorista */
  DataManager.atualizarGanhos(valor);

  /* Limpa corrida */
  DataManager.limparCorrida();

  /* Som de corrida aceita/finalizada */
  SoundService.play("ACEITA");

  window.location.href = "finalizacao.html";
}

</script>

</body>
</html>